<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">

    <div class="max-w-5xl mx-auto">
        <h1 class="text-3xl font-bold mb-6 text-gray-800">üì¶ –°–∫–ª–∞–¥ –ü—Ä–æ–¥—É–∫—Ç–æ–≤</h1>

        <div class="bg-white p-6 rounded-lg shadow-md mb-8 border-l-4 border-indigo-500">
            <h2 class="text-xl font-semibold mb-4 text-gray-700" id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç</h2>
            <form id="productForm" onsubmit="saveProduct(event)" class="flex flex-wrap gap-4 items-end">
                <input type="hidden" id="productId">

                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" id="name" required class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ú–æ–ª–æ–∫–æ">
                </div>

                <div class="w-40">
                    <label class="block text-sm font-medium text-gray-700 mb-1">–¶–µ–Ω–∞</label>
                    <input type="number" id="price" required step="0.01" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="0.00">
                </div>

                <div class="flex gap-2">
                    <button type="submit" id="submitBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition font-medium">
                        –î–æ–±–∞–≤–∏—Ç—å
                    </button>
                    <button type="button" onclick="resetForm()" class="bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition hidden" id="cancelBtn">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>

        <div class="bg-white shadow-md rounded-lg overflow-hidden">
            <div class="p-4 border-b bg-gray-50 flex justify-between items-center">
                <div class="flex gap-2 w-full max-w-md">
                    <input type="number" id="searchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ ID..." class="px-3 py-2 border rounded text-sm w-32">
                    <button onclick="searchById()" class="bg-blue-500 text-white px-4 py-2 rounded text-sm hover:bg-blue-600">–ù–∞–π—Ç–∏</button>
                    <button onclick="fetchAll()" class="bg-gray-500 text-white px-4 py-2 rounded text-sm hover:bg-gray-600">–°–±—Ä–æ—Å</button>
                </div>
                <div class="text-sm text-gray-500">–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: <span id="count" class="font-bold">0</span></div>
            </div>

            <table class="min-w-full leading-normal">
                <thead>
                    <tr class="bg-gray-800 text-white text-sm uppercase">
                        <th class="px-5 py-3 text-left w-16">ID</th>
                        <th class="px-5 py-3 text-left">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                        <th class="px-5 py-3 text-left">–¶–µ–Ω–∞</th>
                        <th class="px-5 py-3 text-right">–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    </tbody>
            </table>
            <div id="loader" class="p-8 text-center text-gray-500 hidden">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
        </div>
    </div>

    <script>
        // ! –ü–†–û–í–ï–†–¨–¢–ï –ü–û–†–¢
        const BASE_URL = 'http://localhost:8082/products';

        // --- 1. –ß–¢–ï–ù–ò–ï (GET) ---
        async function fetchAll() {
            document.getElementById('searchInput').value = '';
            await loadData(BASE_URL);
        }

        async function searchById() {
            const id = document.getElementById('searchInput').value;
            if (!id) return fetchAll();
            await loadData(`${BASE_URL}/${id}`);
        }

        async function loadData(url) {
            const loader = document.getElementById('loader');
            const tbody = document.getElementById('tableBody');
            
            loader.classList.remove('hidden');
            tbody.innerHTML = '';
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ');
                const data = await response.json();
                
                const list = Array.isArray(data) ? data : [data];
                document.getElementById('count').innerText = list.length;

                if (list.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                    return;
                }

                list.forEach(p => {
                    const row = `
                        <tr class="border-b hover:bg-gray-50 group">
                            <td class="px-5 py-4 text-gray-500">${p.id}</td>
                            <td class="px-5 py-4 font-bold text-gray-800">${p.name}</td>
                            <td class="px-5 py-4 text-green-600 font-mono">${p.price} ‚ÇΩ</td>
                            <td class="px-5 py-4 text-right space-x-2">
                                <button onclick="startEdit(${p.id}, '${p.name}', ${p.price})" class="text-blue-500 hover:text-blue-700 font-medium">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                                <button onclick="deleteProduct(${p.id})" class="text-red-500 hover:text-red-700 font-medium">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

            } catch (err) {
                console.error(err);
                alert("–û—à–∏–±–∫–∞: " + err.message);
            } finally {
                loader.classList.add('hidden');
            }
        }

        // --- 2. –£–î–ê–õ–ï–ù–ò–ï (DELETE) ---
        async function deleteProduct(id) {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä —Å ID ' + id + '?')) return;

            try {
                const res = await fetch(`${BASE_URL}/${id}`, { method: 'DELETE' });
                if (res.ok) {
                    fetchAll(); // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                } else {
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (err) {
                alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            }
        }

        // --- 3. –°–û–ó–î–ê–ù–ò–ï –ò –û–ë–ù–û–í–õ–ï–ù–ò–ï (POST / PUT) ---
        async function saveProduct(event) {
            event.preventDefault(); // –ß—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–ª–∞—Å—å

            const id = document.getElementById('productId').value;
            const name = document.getElementById('name').value;
            const price = document.getElementById('price').value;

            const productData = { name: name, price: parseFloat(price) };

            // –ï—Å–ª–∏ –µ—Å—Ç—å ID -> —ç—Ç–æ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (PUT), –∏–Ω–∞—á–µ -> –°–æ–∑–¥–∞–Ω–∏–µ (POST)
            const method = id ? 'PUT' : 'POST';
            const url = id ? `${BASE_URL}/${id}` : BASE_URL;

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(productData)
                });

                if (response.ok) {
                    resetForm(); // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                    fetchAll();  // –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É
                } else {
                    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                }
            } catch (err) {
                console.error(err);
                alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
            }
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
        
        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
        function startEdit(id, name, price) {
            document.getElementById('formTitle').innerText = `–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞ #${id}`;
            document.getElementById('productId').value = id;
            document.getElementById('name').value = name;
            document.getElementById('price').value = price;
            
            document.getElementById('submitBtn').innerText = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            document.getElementById('submitBtn').classList.replace('bg-indigo-600', 'bg-green-600');
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            window.scrollTo({ top: 0, behavior: 'smooth' }); // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–≤–µ—Ä—Ö –∫ —Ñ–æ—Ä–º–µ
        }

        // –°–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        function resetForm() {
            document.getElementById('productForm').reset();
            document.getElementById('productId').value = ''; // –í–∞–∂–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å —Å–∫—Ä—ã—Ç—ã–π ID
            
            document.getElementById('formTitle').innerText = '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–¥—É–∫—Ç';
            document.getElementById('submitBtn').innerText = '–î–æ–±–∞–≤–∏—Ç—å';
            document.getElementById('submitBtn').classList.replace('bg-green-600', 'bg-indigo-600');
            document.getElementById('cancelBtn').classList.add('hidden');
        }

        // –°—Ç–∞—Ä—Ç
        fetchAll();

    </script>
</body>
</html>